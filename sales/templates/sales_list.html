<!-- sales_list.html -->
{% extends "base.html" %}
{% load static %}

{% block title %}Sales List{% endblock title %}

{% block stylesheets %}
<!-- Datatables -->
<link href="{% static 'css/pagination_buttons.css' %}" rel="stylesheet">
<link href="{% static 'vendor/datatables/dataTables.bootstrap4.min.css' %}" rel="stylesheet">
<link href="{% static 'vendor/datatables/buttons.bootstrap4.min.css' %}" rel="stylesheet">

<style>
    .card-header .row {
        align-items: center;
    }
    #salesSearch {
        max-width: 250px;
        border-radius: 15px;
        padding: 5px 15px;
        margin: 10px 0;
    }
    .date-filter {
        display: flex;
        gap: 10px;
        align-items: center;
    }
    .dt-buttons {
        margin-bottom: 15px;
    }
    .dt-buttons .btn {
        margin-right: 5px;
    }
    .dataTables_filter {
        float: right;
    }
    .mdc-card {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
    }
</style>
{% endblock stylesheets %}

{% block content %}
<div class="container-fluid">
    <!-- Page Title -->
    <div class="mdc-card py-2 mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <h4 class="card-title mb-0">Sales Records</h4>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <a href="{% url 'sales:manage_sales' %}" class="btn btn-primary">
            <i class="mdi mdi-plus"></i> New Sale
        </a>
    </div>

    <!-- Sales List Card -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <div class="row">
                <div class="col-md-4">
                    <h6 class="m-0 font-weight-bold text-primary">Sales History</h6>
                </div>
                <div class="col-md-8">
                    <div class="d-flex justify-content-end">
                        <div class="date-filter">
                            <input type="date" class="form-control" id="startDate" placeholder="Start Date">
                            <input type="date" class="form-control" id="endDate" placeholder="End Date">
                            <button class="btn btn-primary" id="filterButton">Filter</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                    <thead>
                        <tr>
                            <th>Code</th>
                            {% if is_admin_or_manager %}
                            <th>Seller</th>
                            {% endif %}
                            <th>Date & Time</th>
                            <th>Products</th>
                            <th>Total Items</th>
                            <th>Grand Total</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for sale in sale_data %}
                        <tr>
                            <td>{{ sale.code }}</td>
                            {% if is_admin_or_manager %}
                            <td>{{ sale.seller }}</td>
                            {% endif %}
                            <td>{{ sale.date_added|date:"d-m-Y H:i" }}</td>
                            <td>
                                {% for product, quantity in sale.products_list.items %}
                                    {{ product }} ({{ quantity }})<br>
                                {% endfor %}
                            </td>
                            <td class="text-center">{{ sale.total_items_sold }}</td>
                            <td class="text-right">{{ sale.grand_total|floatformat:2 }}</td>
                            <td class="text-center">
                                <div class="btn-group">
                                    <a href="{% url 'sales:receipt' sale.id %}" 
                                       class="btn btn-info btn-sm" 
                                       title="View Receipt">
                                        <i class="mdi mdi-receipt"></i>
                                    </a>
                                    <a href="{% url 'sales:manage_sales' sale.id %}" 
                                       class="btn btn-warning btn-sm" 
                                       title="Edit Sale">
                                        <i class="mdi mdi-pencil"></i>
                                    </a>
                                    <a href="{% url 'sales:delete_sales' sale.id %}" 
                                       class="btn btn-danger btn-sm delete-sale" 
                                       title="Delete Sale">
                                        <i class="mdi mdi-delete"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block javascripts %}
<!-- Datatables -->
<script src="{% static 'vendor/datatables/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'vendor/datatables/dataTables.bootstrap4.min.js' %}"></script>
<script src="{% static 'vendor/datatables/dataTables.buttons.min.js' %}"></script>
<script src="{% static 'vendor/datatables/buttons.bootstrap4.min.js' %}"></script>
<script src="{% static 'vendor/datatables/buttons.html5.min.js' %}"></script>
<script src="{% static 'vendor/datatables/buttons.print.min.js' %}"></script>
<script src="{% static 'assets/sweetalert2/sweetalert2@11.js' %}"></script>

<script>
$(document).ready(function() {
    // Initialize DataTable
    const table = $('#dataTable').DataTable({
        dom: 'Bfrtip',
        buttons: [
            {
                extend: 'print',
                text: '<i class="mdi mdi-printer"></i> Print',
                className: 'btn btn-info btn-sm'
            },
            {
                extend: 'excel',
                text: '<i class="mdi mdi-file-excel"></i> Excel',
                className: 'btn btn-success btn-sm'
            },
            {
                extend: 'pdf',
                text: '<i class="mdi mdi-file-pdf"></i> PDF',
                className: 'btn btn-danger btn-sm'
            }
        ],
        order: [[2, 'desc']], // Sort by date column descending
        pageLength: 25
    });

    // Date filter functionality
    $('#filterButton').click(function() {
        const startDate = $('#startDate').val();
        const endDate = $('#endDate').val();
        
        if (startDate && endDate) {
            window.location.href = `?start_date=${startDate}&end_date=${endDate}`;
        } else {
            Swal.fire({
                icon: 'warning',
                title: 'Missing Dates',
                text: 'Please select both start and end dates.'
            });
        }
    });

    // Delete confirmation
    $('.delete-sale').click(function(e) {
        e.preventDefault();
        const deleteUrl = $(this).attr('href');
        
        Swal.fire({
            title: 'Are you sure?',
            text: "This sale will be permanently deleted!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, delete it!'
        }).then((result) => {
            if (result.isConfirmed) {
                window.location.href = deleteUrl;
            }
        });
    });
});
</script>
{% endblock javascripts %}
